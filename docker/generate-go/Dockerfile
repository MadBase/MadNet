FROM golang:1.18-alpine3.15

# some binaries used for code generation can be installed through package manager
RUN apk add --no-cache protoc=3.18.1-r1 capnproto=0.8.0-r1 capnproto-dev=0.8.0-r1

# inherit all permissions from host OS
ARG BUILDER_UID
ARG BUILDER_GIDS
ADD docker/apply-permvars-alpine.sh /
RUN /apply-permvars-alpine.sh
USER $BUILDER_UID

WORKDIR /app
ADD --chown=$BUILDER_UID go.mod go.sum /app/

# other binaries used for code generation are installed from go source
RUN go install github.com/MadBase/go-capnproto2/v2/capnpc-go &&\
    go install github.com/derision-test/go-mockgen/cmd/go-mockgen &&\
    go install golang.org/x/tools/cmd/goimports &&\
    go install github.com/bufbuild/buf/cmd/buf@v1.5.0

CMD go generate -x ./... 